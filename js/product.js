const COLOR_PALETTE = {
  "red": [
    {
      "name": "301",
      "hex": "#851a22"
    },
    {
      "name": "304",
      "hex": "#7a121b"
    },
    {
      "name": "309",
      "hex": "#cb2c48"
    },
    {
      "name": "315",
      "hex": "#86222c"
    },
    {
      "name": "320",
      "hex": "#b6110d"
    },
    {
      "name": "321",
      "hex": "#571b27"
    },
    {
      "name": "328",
      "hex": "#b20e15"
    },
    {
      "name": "337",
      "hex": "#d74027"
    },
    {
      "name": "339",
      "hex": "#6d3327"
    },
    {
      "name": "343",
      "hex": "#5f2a34"
    },
    {
      "name": "344",
      "hex": "#d92c0c"
    },
    {
      "name": "348",
      "hex": "#a51218"
    },
    {
      "name": "362",
      "hex": "#873430"
    },
    {
      "name": "377",
      "hex": "#a8273d"
    },
    {
      "name": "389",
      "hex": "#971f2b"
    },
    {
      "name": "391",
      "hex": "#d02c12"
    },
    {
      "name": "394",
      "hex": "#c52e4d"
    },
    {
      "name": "401",
      "hex": "#7a301a"
    },
    {
      "name": "402",
      "hex": "#532821"
    },
    {
      "name": "408",
      "hex": "#7e2d29"
    },
    {
      "name": "412",
      "hex": "#df4665"
    },
    {
      "name": "419",
      "hex": "#661825"
    },
    {
      "name": "422",
      "hex": "#804331"
    },
    {
      "name": "428",
      "hex": "#b5452f"
    },
    {
      "name": "446",
      "hex": "#72222d"
    },
    {
      "name": "449",
      "hex": "#8e3129"
    },
    {
      "name": "451",
      "hex": "#a61719"
    },
    {
      "name": "452",
      "hex": "#af1515"
    },
    {
      "name": "453",
      "hex": "#b30f16"
    },
    {
      "name": "454",
      "hex": "#9f0e13"
    },
    {
      "name": "455",
      "hex": "#850e10"
    },
    {
      "name": "456",
      "hex": "#7d151c"
    },
    {
      "name": "457",
      "hex": "#5f1722"
    },
    {
      "name": "458",
      "hex": "#43161d"
    },
    {
      "name": "488",
      "hex": "#c93b14"
    },
    {
      "name": "489",
      "hex": "#a51d06"
    },
    {
      "name": "490",
      "hex": "#9f1400"
    },
    {
      "name": "498",
      "hex": "#5d1523"
    },
    {
      "name": "512",
      "hex": "#a2223b"
    },
    {
      "name": "514",
      "hex": "#ab2035"
    },
    {
      "name": "515",
      "hex": "#b61c40"
    },
    {
      "name": "516",
      "hex": "#ad2c42"
    },
    {
      "name": "610",
      "hex": "#675853"
    },
    {
      "name": "611",
      "hex": "#cc3e56"
    },
    {
      "name": "638",
      "hex": "#9c3b3c"
    },
    {
      "name": "657",
      "hex": "#c73d32"
    },
    {
      "name": "658",
      "hex": "#ac263f"
    },
  ],
  "pink": [
    {
      "name": "312",
      "hex": "#b32066"
    },
    {
      "name": "317",
      "hex": "#8b114a"
    },
    {
      "name": "318",
      "hex": "#d47ea3"
    },
    {
      "name": "332",
      "hex": "#901d48"
    },
    {
      "name": "335",
      "hex": "#be2252"
    },
    {
      "name": "340",
      "hex": "#cb2c66"
    },
    {
      "name": "351",
      "hex": "#c194ab"
    },
    {
      "name": "357",
      "hex": "#b54779"
    },
    {
      "name": "359",
      "hex": "#702539"
    },
    {
      "name": "375",
      "hex": "#8e4b5c"
    },
    {
      "name": "382",
      "hex": "#d0504f"
    },
    {
      "name": "385",
      "hex": "#b92257"
    },
    {
      "name": "396",
      "hex": "#6a0342"
    },
    {
      "name": "399",
      "hex": "#882d66"
    },
    {
      "name": "437",
      "hex": "#b82b70"
    },
    {
      "name": "499",
      "hex": "#630d2a"
    },
    {
      "name": "500",
      "hex": "#680b28"
    },
    {
      "name": "511",
      "hex": "#a32048"
    },
    {
      "name": "513",
      "hex": "#b92255"
    },
    {
      "name": "517",
      "hex": "#8b193d"
    },
    {
      "name": "518",
      "hex": "#710624"
    },
    {
      "name": "519",
      "hex": "#680b26"
    },
    {
      "name": "625",
      "hex": "#c8495e"
    },
    {
      "name": "652",
      "hex": "#a43d58"
    },
    {
      "name": "654",
      "hex": "#841a46"
    },
    {
      "name": "655",
      "hex": "#cf455f"
    },
    {
      "name": "656",
      "hex": "#d8534e"
    },
  ],
  "purple": [
    {
      "name": "306",
      "hex": "#51193f"
    },
    {
      "name": "347",
      "hex": "#271642"
    },
    {
      "name": "379",
      "hex": "#52062d"
    },
    {
      "name": "409",
      "hex": "#410d3b"
    },
    {
      "name": "432",
      "hex": "#4a183e"
    },
    {
      "name": "441",
      "hex": "#4e1645"
    },
    {
      "name": "442",
      "hex": "#904190"
    },
    {
      "name": "492",
      "hex": "#4b2a6f"
    },
    {
      "name": "493",
      "hex": "#29164e"
    },
    {
      "name": "494",
      "hex": "#3e2054"
    },
    {
      "name": "495",
      "hex": "#462254"
    },
    {
      "name": "496",
      "hex": "#35112b"
    },
    {
      "name": "497",
      "hex": "#430a2b"
    },
    {
      "name": "520",
      "hex": "#58062c"
    },
    {
      "name": "629",
      "hex": "#995f92"
    },
    {
      "name": "631",
      "hex": "#813482"
    },
    {
      "name": "650",
      "hex": "#9c6697"
    },
  ],
  "blue": [
    {
      "name": "302",
      "hex": "#0f0d56"
    },
    {
      "name": "313",
      "hex": "#0e142c"
    },
    {
      "name": "316",
      "hex": "#1c7fd4"
    },
    {
      "name": "323",
      "hex": "#156274"
    },
    {
      "name": "331",
      "hex": "#0576c6"
    },
    {
      "name": "336",
      "hex": "#1b5280"
    },
    {
      "name": "345",
      "hex": "#7e5da4"
    },
    {
      "name": "349",
      "hex": "#1c2e60"
    },
    {
      "name": "352",
      "hex": "#052675"
    },
    {
      "name": "361",
      "hex": "#0772b6"
    },
    {
      "name": "367",
      "hex": "#054557"
    },
    {
      "name": "369",
      "hex": "#534d8d"
    },
    {
      "name": "373",
      "hex": "#094543"
    },
    {
      "name": "376",
      "hex": "#1f9088"
    },
    {
      "name": "388",
      "hex": "#13454e"
    },
    {
      "name": "397",
      "hex": "#125fad"
    },
    {
      "name": "400",
      "hex": "#0b8cc0"
    },
    {
      "name": "404",
      "hex": "#106197"
    },
    {
      "name": "407",
      "hex": "#144dae"
    },
    {
      "name": "411",
      "hex": "#202f4e"
    },
    {
      "name": "416",
      "hex": "#273236"
    },
    {
      "name": "417",
      "hex": "#693c91"
    },
    {
      "name": "418",
      "hex": "#195fa7"
    },
    {
      "name": "420",
      "hex": "#5760a1"
    },
    {
      "name": "424",
      "hex": "#4b2973"
    },
    {
      "name": "435",
      "hex": "#5657a9"
    },
    {
      "name": "439",
      "hex": "#026e88"
    },
    {
      "name": "440",
      "hex": "#1d2a4d"
    },
    {
      "name": "444",
      "hex": "#17484c"
    },
    {
      "name": "448",
      "hex": "#0a3c5d"
    },
    {
      "name": "450",
      "hex": "#435772"
    },
    {
      "name": "491",
      "hex": "#5f388b"
    },
    {
      "name": "506",
      "hex": "#0c2c93"
    },
    {
      "name": "507",
      "hex": "#102f99"
    },
    {
      "name": "508",
      "hex": "#0c126a"
    },
    {
      "name": "509",
      "hex": "#040e55"
    },
    {
      "name": "510",
      "hex": "#101058"
    },
    {
      "name": "531",
      "hex": "#0e765d"
    },
    {
      "name": "535",
      "hex": "#1c675c"
    },
    {
      "name": "536",
      "hex": "#174a75"
    },
    {
      "name": "537",
      "hex": "#163a50"
    },
    {
      "name": "538",
      "hex": "#0a475c"
    },
    {
      "name": "539",
      "hex": "#0d2e27"
    },
    {
      "name": "540",
      "hex": "#11273c"
    },
    {
      "name": "602",
      "hex": "#0e1f4b"
    },
    {
      "name": "603",
      "hex": "#161e42"
    },
    {
      "name": "604",
      "hex": "#222945"
    },
    {
      "name": "619",
      "hex": "#0a8187"
    },
    {
      "name": "623",
      "hex": "#697792"
    },
    {
      "name": "633",
      "hex": "#038bb1"
    },
    {
      "name": "636",
      "hex": "#434554"
    },
    {
      "name": "641",
      "hex": "#7daeb3"
    },
    {
      "name": "647",
      "hex": "#0b8a9b"
    },
    {
      "name": "661",
      "hex": "#2d3341"
    },
  ],
  "green": [
    {
      "name": "305",
      "hex": "#309f1f"
    },
    {
      "name": "310",
      "hex": "#076b35"
    },
    {
      "name": "311",
      "hex": "#005214"
    },
    {
      "name": "314",
      "hex": "#6f862e"
    },
    {
      "name": "319",
      "hex": "#04351c"
    },
    {
      "name": "329",
      "hex": "#207a3d"
    },
    {
      "name": "334",
      "hex": "#216a3c"
    },
    {
      "name": "338",
      "hex": "#167d48"
    },
    {
      "name": "341",
      "hex": "#2f3d30"
    },
    {
      "name": "346",
      "hex": "#375b2d"
    },
    {
      "name": "350",
      "hex": "#034e39"
    },
    {
      "name": "355",
      "hex": "#658d09"
    },
    {
      "name": "366",
      "hex": "#2f8521"
    },
    {
      "name": "370",
      "hex": "#618754"
    },
    {
      "name": "383",
      "hex": "#106b3c"
    },
    {
      "name": "413",
      "hex": "#40673a"
    },
    {
      "name": "414",
      "hex": "#246043"
    },
    {
      "name": "421",
      "hex": "#436540"
    },
    {
      "name": "423",
      "hex": "#76bd3d"
    },
    {
      "name": "443",
      "hex": "#4e672e"
    },
    {
      "name": "471",
      "hex": "#4cab1c"
    },
    {
      "name": "472",
      "hex": "#1a8728"
    },
    {
      "name": "473",
      "hex": "#389e1f"
    },
    {
      "name": "474",
      "hex": "#106e22"
    },
    {
      "name": "475",
      "hex": "#135124"
    },
    {
      "name": "476",
      "hex": "#0b4922"
    },
    {
      "name": "477",
      "hex": "#133e22"
    },
    {
      "name": "478",
      "hex": "#162f24"
    },
    {
      "name": "532",
      "hex": "#025d43"
    },
    {
      "name": "533",
      "hex": "#0d7948"
    },
    {
      "name": "534",
      "hex": "#025121"
    },
    {
      "name": "626",
      "hex": "#7ca074"
    },
    {
      "name": "639",
      "hex": "#516b60"
    },
  ],
  "yellow": [
    {
      "name": "303",
      "hex": "#d9941c"
    },
    {
      "name": "307",
      "hex": "#c66b18"
    },
    {
      "name": "322",
      "hex": "#bb701f"
    },
    {
      "name": "326",
      "hex": "#ea5213"
    },
    {
      "name": "333",
      "hex": "#ed8232"
    },
    {
      "name": "354",
      "hex": "#b0681b"
    },
    {
      "name": "356",
      "hex": "#be8b52"
    },
    {
      "name": "358",
      "hex": "#c09008"
    },
    {
      "name": "360",
      "hex": "#c57e08"
    },
    {
      "name": "364",
      "hex": "#907526"
    },
    {
      "name": "365",
      "hex": "#e59773"
    },
    {
      "name": "371",
      "hex": "#e17a40"
    },
    {
      "name": "372",
      "hex": "#ccc982"
    },
    {
      "name": "374",
      "hex": "#e78f2d"
    },
    {
      "name": "378",
      "hex": "#bfa960"
    },
    {
      "name": "381",
      "hex": "#b3891d"
    },
    {
      "name": "384",
      "hex": "#e67f17"
    },
    {
      "name": "386",
      "hex": "#e5b15b"
    },
    {
      "name": "387",
      "hex": "#d26838"
    },
    {
      "name": "390",
      "hex": "#a54603"
    },
    {
      "name": "393",
      "hex": "#dda66d"
    },
    {
      "name": "398",
      "hex": "#c0a151"
    },
    {
      "name": "403",
      "hex": "#c19665"
    },
    {
      "name": "415",
      "hex": "#b06105"
    },
    {
      "name": "425",
      "hex": "#474030"
    },
    {
      "name": "429",
      "hex": "#cfaa64"
    },
    {
      "name": "431",
      "hex": "#707928"
    },
    {
      "name": "436",
      "hex": "#977a1f"
    },
    {
      "name": "445",
      "hex": "#dcaf54"
    },
    {
      "name": "466",
      "hex": "#c8c0a9"
    },
    {
      "name": "467",
      "hex": "#ccbf8b"
    },
    {
      "name": "468",
      "hex": "#c8bb8f"
    },
    {
      "name": "469",
      "hex": "#b5aa58"
    },
    {
      "name": "470",
      "hex": "#c7af11"
    },
    {
      "name": "481",
      "hex": "#d3b505"
    },
    {
      "name": "482",
      "hex": "#e1bc12"
    },
    {
      "name": "483",
      "hex": "#e0a017"
    },
    {
      "name": "484",
      "hex": "#e99418"
    },
    {
      "name": "485",
      "hex": "#ea8e14"
    },
    {
      "name": "486",
      "hex": "#e17417"
    },
    {
      "name": "487",
      "hex": "#dd7116"
    },
    {
      "name": "501",
      "hex": "#bd7803"
    },
    {
      "name": "502",
      "hex": "#a15406"
    },
    {
      "name": "503",
      "hex": "#ad510b"
    },
    {
      "name": "504",
      "hex": "#ae5210"
    },
    {
      "name": "505",
      "hex": "#be5f1e"
    },
    {
      "name": "524",
      "hex": "#e3c9a4"
    },
    {
      "name": "525",
      "hex": "#dfb779"
    },
    {
      "name": "526",
      "hex": "#d7bda4"
    },
    {
      "name": "528",
      "hex": "#cd9d5b"
    },
    {
      "name": "529",
      "hex": "#c2ab75"
    },
    {
      "name": "530",
      "hex": "#c3a684"
    },
    {
      "name": "612",
      "hex": "#dbaf10"
    },
    {
      "name": "614",
      "hex": "#639d24"
    },
    {
      "name": "615",
      "hex": "#c5b59b"
    },
    {
      "name": "617",
      "hex": "#7c9b4f"
    },
    {
      "name": "618",
      "hex": "#a87e42"
    },
    {
      "name": "620",
      "hex": "#dd751c"
    },
    {
      "name": "621",
      "hex": "#818517"
    },
    {
      "name": "622",
      "hex": "#c5b6a1"
    },
    {
      "name": "624",
      "hex": "#edc554"
    },
    {
      "name": "632",
      "hex": "#d1b110"
    },
    {
      "name": "640",
      "hex": "#c19d47"
    },
    {
      "name": "642",
      "hex": "#b88e52"
    },
    {
      "name": "644",
      "hex": "#c39637"
    },
    {
      "name": "649",
      "hex": "#d67751"
    },
  ],
  "brown": [
    {
      "name": "342",
      "hex": "#7c633a"
    },
    {
      "name": "368",
      "hex": "#b18f50"
    },
    {
      "name": "380",
      "hex": "#b9915e"
    },
    {
      "name": "406",
      "hex": "#734523"
    },
    {
      "name": "410",
      "hex": "#5c3a1f"
    },
    {
      "name": "430",
      "hex": "#39302b"
    },
    {
      "name": "447",
      "hex": "#a88658"
    },
    {
      "name": "527",
      "hex": "#bd9b6d"
    },
    {
      "name": "606",
      "hex": "#6a5844"
    },
    {
      "name": "607",
      "hex": "#6b594f"
    },
    {
      "name": "608",
      "hex": "#604d46"
    },
    {
      "name": "609",
      "hex": "#68523d"
    },
    {
      "name": "613",
      "hex": "#b39360"
    },
    {
      "name": "616",
      "hex": "#aa6f51"
    },
    {
      "name": "627",
      "hex": "#b38352"
    },
    {
      "name": "628",
      "hex": "#ae9880"
    },
    {
      "name": "635",
      "hex": "#a78560"
    },
    {
      "name": "637",
      "hex": "#a17e50"
    },
    {
      "name": "646",
      "hex": "#9c7353"
    },
    {
      "name": "648",
      "hex": "#81683f"
    },
  ],
  "black": [
    {
      "name": "Pure Black",
      "hex": "#000000"
    },  
    {
      "name": "308",
      "hex": "#14281f"
    },
    {
      "name": "325",
      "hex": "#2c2b30"
    },
    {
      "name": "327",
      "hex": "#1a2828"
    },
    {
      "name": "330",
      "hex": "#2a232a"
    },
    {
      "name": "438",
      "hex": "#271418"
    },
    {
      "name": "459",
      "hex": "#34131a"
    },
    {
      "name": "460",
      "hex": "#220d12"
    },
    {
      "name": "479",
      "hex": "#16261c"
    },
    {
      "name": "480",
      "hex": "#0d1216"
    },
    {
      "name": "601",
      "hex": "#161825"
    },
    {
      "name": "605",
      "hex": "#0b0e20"
    },
    {
      "name": "662",
      "hex": "#39241f"
    },
    {
      "name": "663",
      "hex": "#21161a"
    },
    {
      "name": "664",
      "hex": "#221819"
    },
  ],
  "white": [
    
    {
      "name": "Pure White",
      "hex": "#ffffff"
    },    
    {
      "name": "324",
      "hex": "#cec8c8"
    },
    {
      "name": "353",
      "hex": "#c6c0c0"
    },
    {
      "name": "363",
      "hex": "#c7c7bf"
    },
    {
      "name": "392",
      "hex": "#9a9da6"
    },
    {
      "name": "395",
      "hex": "#c0b7ae"
    },
    {
      "name": "427",
      "hex": "#6b6c70"
    },
    {
      "name": "434",
      "hex": "#54565b"
    },
    {
      "name": "461",
      "hex": "#d2d0d5"
    },
    {
      "name": "462",
      "hex": "#d2cdc9"
    },
    {
      "name": "463",
      "hex": "#ddd8d2"
    },
    {
      "name": "464",
      "hex": "#d5d2cb"
    },
    {
      "name": "465",
      "hex": "#d8cfbe"
    },
    {
      "name": "521",
      "hex": "#ddd4c3"
    },
    {
      "name": "522",
      "hex": "#dcd9c6"
    },
    {
      "name": "523",
      "hex": "#d8d0bb"
    },
    {
      "name": "630",
      "hex": "#a0998f"
    },
    {
      "name": "634",
      "hex": "#c5b9a9"
    },
    {
      "name": "643",
      "hex": "#d4becb"
    },
    {
      "name": "645",
      "hex": "#b9b9c1"
    },
    {
      "name": "659",
      "hex": "#989898"
    },
    {
      "name": "660",
      "hex": "#5b5d69"
    },
  ],
};

const LINING_QUALITIES = ["Rs.35", "Rs.45", "Rs.55", "Rs.65"];

/* =========================================
   STATE
========================================= */

let selectedColor = null;
let selectedQuality = null;
let selectedQuantity = 1;
let currentPrice = 0;
let discountedPrice = null;

/* =========================================
   URL PARAMS
========================================= */

const params = new URLSearchParams(window.location.search);
const productId = params.get("id");
const materialName = params.get("material");

/* =========================================
   HARD CODED MATERIAL PRODUCTS
========================================= */

const MATERIAL_PRODUCTS = {
"Lining": {
  price: 35,
  quantity_unit: "meter",
  description: `
Polyester Linings are available at ₹35 and ₹45. Durable, wrinkle-resistant, and easy to maintain. Polyester linings offer a smooth finish and structured fall, making them ideal for everyday wear and fast-fashion styles. They are affordable and long-lasting, though slightly less breathable compared to cotton.
Cotton Linings are available at ₹55 and ₹65. Soft, breathable, and gentle on the skin. Cotton lining is perfect for summer wear, cotton garments, and customers who prioritize comfort. It allows airflow and feels natural against the body.
`
},

"Two by Two": {
  price: 180,
  description: "2x2 Cotton (Rubia) is a lightweight and durable 100% cotton fabric woven in a 2x2 structure, giving it balanced strength, subtle texture, and breathability. Ideal for saree blouses, salwar kameez, lining materials, and traditional wear. Comfortable for daily use and suitable for warm climates.",
  quantity_unit: "meter"
},

"Silk Cotton": {
  price: 110,
  description: "Silk Cotton offers a soft, smooth feel with a gentle pearl-like sheen. Lightweight, breathable, and moisture-wicking, it is suitable for warm climates. More durable and easier to maintain than pure silk, making it ideal for festive and everyday elegant wear.",
  quantity_unit: "meter"
},

"Plain Net": {
  price: 80,
  description: "Plain Soft Net is a lightweight, breathable fabric with an open-weave structure and smooth texture. Commonly used for gowns, bridal veils, lehengas, and decorative layering. Durable yet flexible, suitable for embroidery and embellishments.",
  quantity_unit: "meter"
},

"Poplin": {
  price: 110,
  description: "Poplin is a lightweight, durable plain-weave fabric with a fine rib texture and crisp finish. Strong, breathable, and easy to maintain, it is ideal for shirts, dresses, and daily wear. Cotton poplin is soft and comfortable for warm weather.",
  quantity_unit: "meter"
},

"Suncrepe": {
  price: 50,
  description: "Sun Crepe is a lightweight fabric with a smooth texture and graceful drape. Commonly used for blouses, kurtis, skirts, dresses, and lining for formal garments. Easy to maintain and versatile for modern designs.",
  quantity_unit: "meter"
},

"Falls": {
  price: 20,
  description: "Arvind Polyester Saree Falls are made from 100% polyester to reinforce and protect saree hems. Provides added weight and structure for better drape. Durable and essential for proper saree finishing.",
  quantity_unit: "unit"
},

"Satin": {
  price: 110,
  description: "Moss Satin is a smooth, lightweight fabric with a soft drape and subtle sheen. Suitable for evening gowns, sarees, blouses, and decorative items. Elegant finish with refined shine, ideal for festive and formal wear.",
  quantity_unit: "meter"
},
};

/* =========================================
   LOAD PRODUCT
========================================= */

if (materialName && MATERIAL_PRODUCTS[materialName]) {

  const config = MATERIAL_PRODUCTS[materialName];

  renderProduct({
    id: materialName,
    name: materialName,
    description: config.description,
    category: materialName,
    price: config.price,
    discounted_price: null,
    quantity_unit: config.quantity_unit
  });

} else if (productId) {

  fetch(`${window.BASE_API}/products/${productId}`)
    .then(res => res.json())
    .then(product => renderProduct(product));
}

/* =========================================
   RENDER PRODUCT
========================================= */

function renderProduct(product) {

  document.getElementById("productName").textContent = product.name;
  document.getElementById("productDescription").textContent = product.description || "";

  currentPrice = product.price;
  discountedPrice = product.discounted_price || null;
  updatePriceUI(currentPrice, discountedPrice);

  /* ===== IMAGES ===== */

  const mainImage = document.getElementById("mainImage");
  const imageSection = document.getElementById("imageSection");

  if (!materialName) {

    mainImage.src = product.image_url;

    const extraImages = document.getElementById("extraImages");
    extraImages.innerHTML = "";

    (product.extra_images || []).forEach(url => {
      const img = document.createElement("img");
      img.src = url;
      img.onclick = () => mainImage.src = url;
      extraImages.appendChild(img);
    });

  } else {
    if (imageSection) imageSection.style.display = "none";
  }

  /* ===== COLOR ===== */

  if (materialName) {
    renderColorPalette();
  } else {
    document.getElementById("colorSection").style.display = "none";
  }

  /* ===== QUALITY ===== */

  if (product.category?.toLowerCase() === "lining") {
    renderQualityOptions();
  } else {
    document.getElementById("qualitySection").style.display = "none";
  }

  const lensBtn = document.getElementById("lensBtn");

if (materialName) {
  lensBtn.style.display = "inline-block";
}

  /* ===== QUANTITY ===== */

  renderQuantity(product.quantity_unit);

  /* ===== ADD TO CART ===== */

  document.getElementById("addToCartBtn").onclick =
    () => addToCart(product);
}

/* =========================================
   ADD TO CART
========================================= */

function addToCart(product) {

  if (materialName && !selectedColor) {
    alert("Please select a color");
    return;
  }

  if (product.category?.toLowerCase() === "lining" && !selectedQuality) {
    alert("Please select lining quality");
    return;
  }

  const cart = JSON.parse(localStorage.getItem("cart")) || [];

  cart.push({
    product_id: product.id,
    name: product.name,
    category: product.category,
    color: selectedColor,
    quality: selectedQuality,
    quantity: selectedQuantity,
    unit: product.quantity_unit,
    price: discountedPrice || currentPrice
  });

  localStorage.setItem("cart", JSON.stringify(cart));
  alert("Product added to cart");
}

/* =========================================
   PRICE UI
========================================= */

function updatePriceUI(price, discounted) {
  const priceEl = document.getElementById("productPrice");
  priceEl.innerHTML = discounted
    ? `<span class="old-price">₹${price}</span>
       <span class="new-price">₹${discounted}</span>`
    : `<span class="new-price">₹${price}</span>`;
}

/* =========================================
   QUANTITY
========================================= */

function renderQuantity(unit) {

  const container = document.getElementById("quantityControl");
  container.innerHTML = "";

  const wrap = document.createElement("div");
  wrap.className = "quantity-buttons";

  const minus = document.createElement("button");
  minus.textContent = "−";

  const plus = document.createElement("button");
  plus.textContent = "+";

  const label = document.createElement("span");

  // default start value
  selectedQuantity = unit === "meter" ? 0.5 : 1;

  function updateLabel() {
if (unit === "meter") {
  label.textContent =
    selectedQuantity + (selectedQuantity <= 1 ? " meter" : " meters");
}

else {
      label.textContent =
        selectedQuantity + (selectedQuantity === 1 ? " unit" : " units");
    }
  }

  updateLabel();

  minus.onclick = () => {

    if (unit === "meter") {
      if (selectedQuantity > 0.5) {
        selectedQuantity -= 0.5;
      }
    } else {
      if (selectedQuantity > 1) {
        selectedQuantity -= 1;
      }
    }

    updateLabel();
  };

  plus.onclick = () => {

    if (unit === "meter") {
      selectedQuantity += 0.5;
    } else {
      selectedQuantity += 1;
    }

    updateLabel();
  };

  wrap.append(minus, label, plus);
  container.appendChild(wrap);
}

/* =========================================
   COLOR PALETTE
========================================= */

function renderColorPalette() {

  const palette = document.getElementById("colorPalette");
  palette.innerHTML = "";

  Object.values(COLOR_PALETTE).flat().forEach(color => {

    const swatch = document.createElement("div");
    swatch.className = "color-swatch";
    swatch.style.background = color.hex;
    swatch.title = color.name;

    swatch.onclick = () => {
      document.querySelectorAll(".color-swatch")
        .forEach(s => s.classList.remove("active"));

      swatch.classList.add("active");
      selectedColor = color;
    };

    palette.appendChild(swatch);
  });
}

/* =========================================
   FILTER COLORS BY FAMILY
========================================= */

function filterColorsByFamily(colorFamily) {

  const palette = document.getElementById("colorPalette");
  palette.innerHTML = "";

  if (!COLOR_PALETTE[colorFamily]) return;

  COLOR_PALETTE[colorFamily].forEach(color => {

    const swatch = document.createElement("div");
    swatch.className = "color-swatch";
    swatch.style.background = color.hex;
    swatch.title = color.name;

    swatch.onclick = () => {
      document.querySelectorAll(".color-swatch")
        .forEach(s => s.classList.remove("active"));

      swatch.classList.add("active");
      selectedColor = color;
    };

    palette.appendChild(swatch);
  });
}

/* =========================================
   LINING QUALITY
========================================= */

function renderQualityOptions() {

  const container = document.getElementById("qualityOptions");
  container.innerHTML = "";

  LINING_QUALITIES.forEach(q => {

    const box = document.createElement("div");
    box.className = "quality-box";
    box.textContent = q;

    box.onclick = () => {
      document.querySelectorAll(".quality-box")
        .forEach(b => b.classList.remove("active"));

      box.classList.add("active");
      selectedQuality = q;

      currentPrice = Number(q.replace("Rs.", ""));
      updatePriceUI(currentPrice, null);
    };

    container.appendChild(box);
  });
}

// ======================================
// CAMERA + COLOR DETECTION
// ======================================

const lensBtn = document.getElementById("lensBtn");
const cameraModal = document.getElementById("cameraModal");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const captureBtn = document.getElementById("captureBtn");
const closeCamera = document.getElementById("closeCamera");
const colorResult = document.getElementById("colorResult");

let stream = null;

// OPEN CAMERA
lensBtn.onclick = async () => {

  cameraModal.style.display = "block";

  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });

  video.srcObject = stream;
  await video.play();

  colorResult.innerHTML = "";
};

// CLOSE CAMERA
closeCamera.onclick = () => {
  cameraModal.style.display = "none";
  if (stream) stream.getTracks().forEach(t => t.stop());
};

// RGB → HSV
function rgbToHsv(r, g, b) {
  r /= 255; g /= 255; b /= 255;
  const max = Math.max(r,g,b), min = Math.min(r,g,b);
  const d = max - min;
  let h = 0;

  if (d !== 0) {
    if (max === r) h = ((g - b) / d) % 6;
    else if (max === g) h = (b - r) / d + 2;
    else h = (r - g) / d + 4;
    h *= 60;
    if (h < 0) h += 360;
  }

  const s = max === 0 ? 0 : d / max;
  const v = max;

  return { h, s, v };
}

// DETECT COLOR FAMILY
function getColorName(r, g, b) {

  const { h, s, v } = rgbToHsv(r, g, b);

  if (v < 0.2) return "black";
  if (v > 0.9 && s < 0.25) return "white";

  if (s < 0.25) {
    if (v < 0.6) return "brown";
    return "white";
  }

  if (h >= 35 && h <= 65) return "yellow";
  if (h > 65 && h <= 160) return "green";
  if (h > 160 && h <= 260) return "blue";
  if (h > 260 && h <= 320) return "purple";
  if (h < 20 || h > 340) return "red";

  return "brown";
}

captureBtn.onclick = () => {

  if (!video.videoWidth) return;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.drawImage(video, 0, 0);

  const data = ctx.getImageData(
    canvas.width * 0.3,
    canvas.height * 0.3,
    canvas.width * 0.4,
    canvas.height * 0.4
  ).data;

  let r = 0, g = 0, b = 0, count = 0;

  for (let i = 0; i < data.length; i += 4) {
    r += data[i];
    g += data[i+1];
    b += data[i+2];
    count++;
  }

  r = Math.round(r / count);
  g = Math.round(g / count);
  b = Math.round(b / count);

  const detected = getColorName(r, g, b);

  console.log("Detected:", detected);

  filterColorsByFamily(detected);

  // Close camera
  cameraModal.style.display = "none";
  if (stream) stream.getTracks().forEach(t => t.stop());
};